on:
  push:
    branches: [main]
  pull_request:
  release:
    types: [released]
  workflow_dispatch:
    inputs:
      tag:
        description: Tag to which the report should be attached (leave blank for none).
        required: false
      pr:
        description: PR number to which comment should be added (leave blank for none).
        required: false

name: Package QC Report

permissions:
  contents: write
  pull-requests: write
  issues: read

jobs:
  qc-report:
    runs-on: ubuntu-latest
    env:
      GITHUB_PAT: ${{ secrets.GITHUB_TOKEN }}

    steps:
      - uses: actions/checkout@v5

      - uses: r-lib/actions/setup-r@v2
        with:
          use-public-rspm: true

      - uses: r-lib/actions/setup-r-dependencies@v2
        with:
          extra-packages: local::.

      - name: QC report
        run: |
          lTestResults <- testthat::test_local(
            stop_on_failure = FALSE,
            reporter = "silent"
          )
          IssueTestMatrix <- qcthat::CompileIssueTestMatrix(
            dfRepoIssues = qcthat::FetchRepoIssues(),
            dfTestResults = qcthat::CompileTestResults(lTestResults)
          )
          print(IssueTestMatrix)

          # Also print to a file.
          print(IssueTestMatrix, con = "qc_report.txt")
        shell: Rscript {0}

      - name: Add comment to PR
        if: github.event_name == 'pull_request' || inputs.pr != ''
        uses: actions/github-script@v6
        with:
          script: |
            // Figure out issue number first so we can give up fast if we can't
            // find it.
            let issueNumber;
            if (context.eventName === 'pull_request') {
              issueNumber = context.issue.number;
            } else if (inputs.pr) {
              issueNumber = inputs.pr;
            }
            if (!issueNumber) {
              console.log('Could not determine issue/PR number. Skipping comment.');
              return;
            }

            // Parse qc_report.txt to generate comment.

            const fs = require('fs');

            let reportContent;
            try {
              reportContent = fs.readFileSync('qc_report.txt', 'utf8');
            } catch (err) {
              console.error('Error reading qc_report.txt:', err);
              core.setFailed('Failed to read qc_report.txt');
              return;
            }

            // Split into lines
            const lines = reportContent.split(/[\r\n]+/);

            // Find the index of the first non-empty line
            const firstLineIndex = lines.findIndex(line => line.trim() !== '');

            // If there aren't any, there's nothing to comment.
            if (firstLineIndex == -1) {
              console.log('Empty qc_report.txt. Skipping comment.');
              return;
            }

            // Find the index of the last non-empty line
            const lastLineIndex = lines.findLastIndex(line => line.trim() !== '');

            if (lastLineIndex <= firstLineIndex) {
              console.log('Empty qc_report.txt. Skipping comment.');
              return;
            }

            reportSummary = lines[firstLineIndex].trim();
            reportOutcome = lines[lastLineIndex].trim();
            bodyContent = lines.slice(firstLineIndex + 1, lastLineIndex).join('\n');

            const commentBody = `
            ## QC Report

            <details>
            <summary>${reportSummary}</summary>

            \`\`\`
            ${bodyContent}
            \`\`\`

            </details>

            ${reportOutcome}
            `;

            try {
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: commentBody,
              });
            } catch (error) {
              console.error(`Error creating comment: ${error.message}`);
              core.setFailed(`Failed to create PR comment: ${error.message}`);
            };

      - name: Add to release
        if: github.event_name == 'release' || inputs.tag != ''
        uses: svenstaro/upload-release-action@v2
        with:
          file: qc_report.txt
          asset_name: qc_report_$tag.txt
          tag: ${{ github.event.release.tag_name || inputs.tag }}
          overwrite: true
